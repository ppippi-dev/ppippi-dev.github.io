---
layout: post
title: "Terraform – Consuming Remote State"
categories: [Terraform]
tags: [Terraform]
---

> Reference: *Terraform Up & Running* (O’Reilly)

Splitting Terraform into multiple projects keeps things organized, but you still need a way to share outputs across them (e.g., RDS credentials → EC2 app). That’s where `terraform_remote_state` comes in.

<br>

### Remote Backend Recap

As before, we use S3 + DynamoDB for centralized state storage (see code snippet in this [gist](https://gist.github.com/wjdqlsdlsp/c3d6ff920344096df18b893cf4eb8e7b)).

State layout:

```
stage/
├── data-store/mysql/terraform.tfstate
└── services/webserver/terraform.tfstate
```

<br>

### Step 1. Provision RDS

Define the database stack separately (example from HashiCorp’s docs; gist [here](https://gist.github.com/wjdqlsdlsp/bb67dc8a42be5c4490aed308d5e7367b)). Important: expose the connection details via `output`s so they’re stored in the state file.

Initialize/apply—it can take a few minutes for Amazon RDS to provision.

<br>

### Step 2. Reference Remote State in the EC2 Stack

Inside the EC2 project, use `terraform_remote_state` to read values from the RDS state:

```hcl
data "terraform_remote_state" "db" {
  backend = "s3"

  config = {
    bucket = "jeongbin-terraform-bucket"
    key    = "stage/data-store/mysql/terraform.tfstate"
    region = "ap-northeast-2"
  }
}
```

Outputs from the DB stack become accessible at `data.terraform_remote_state.db.outputs.*`. Remember: remote state is **read-only**—great for stability.

<br>

### Step 3. Create EC2 Using the Imported Values

Use the remote outputs in user data, security groups, etc. (full snippet in [this gist](https://gist.github.com/wjdqlsdlsp/234e30e8be209c81de60b09de4eaa56e)).

Example:

```hcl
user_data = <<-EOF
            #!/bin/bash
            cat <<EOT >> /var/www/html/config
            DB_HOST = "${data.terraform_remote_state.db.outputs.address}"
            DB_NAME = "${data.terraform_remote_state.db.outputs.name}"
            DB_USER = "${data.terraform_remote_state.db.outputs.username}"
            DB_PASS = "${data.terraform_remote_state.db.outputs.password}"
            EOT
            EOF
```

Initialize/apply the EC2 stack. Terraform pulls the RDS info from S3 and injects it into the instance.

<br>

<p align="center"><img src="/assets/img/post_img/terraform4.png"></p>

Now the EC2 instance “knows” how to reach the database—all via Terraform-managed state.***
