---
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import FallbackImage from '../assets/default_img.webp';

type RelatedPost = { slug: string; title: string; pubDate: Date };
type NavPost = { slug: string; title: string };
type Props = CollectionEntry<'blog'>['data'] & { slug?: string; body?: string; relatedPosts?: RelatedPost[]; prevPost?: NavPost | null; nextPost?: NavPost | null };

const { title, description, pubDate, updatedDate, heroImage, tags, slug, body, relatedPosts, prevPost, nextPost } = Astro.props;

function calculateReadingTime(text: string): number {
	if (!text) return 1;
	const cleanText = text
		.replace(/```[\s\S]*?```/g, '')
		.replace(/`[^`]*`/g, '')
		.replace(/\[([^\]]*)\]\([^)]*\)/g, '$1')
		.replace(/[#*_~>\-|]/g, '')
		.replace(/\s+/g, '');
	const charsPerMinute = 500;
	const minutes = Math.ceil(cleanText.length / charsPerMinute);
	return Math.max(1, minutes);
}

const readingTime = calculateReadingTime(body || '');
const imageUrl = heroImage ? new URL(heroImage, Astro.site).href : new URL(FallbackImage.src, Astro.site).href;
---

<html lang="ko">
	<head>
		<BaseHead title={title} description={description} />
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "BlogPosting",
			"headline": title,
			"description": description || title,
			"image": imageUrl,
			"datePublished": pubDate.toISOString(),
			"dateModified": updatedDate ? updatedDate.toISOString() : pubDate.toISOString(),
			"author": {
				"@type": "Person",
				"name": "ppippi",
				"url": "https://ppippi.dev"
			},
			"publisher": {
				"@type": "Organization",
				"name": "ppippi-dev Blog",
				"url": "https://ppippi.dev"
			},
			"mainEntityOfPage": {
				"@type": "WebPage",
				"@id": Astro.url.href
			},
			"keywords": tags ? tags.join(", ") : undefined
		})} />
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "BreadcrumbList",
			"itemListElement": [
				{
					"@type": "ListItem",
					"position": 1,
					"name": "홈",
					"item": "https://ppippi.dev"
				},
				{
					"@type": "ListItem",
					"position": 2,
					"name": "블로그",
					"item": "https://ppippi.dev/blog/"
				},
				{
					"@type": "ListItem",
					"position": 3,
					"name": title
				}
			]
		})} />
		<style>
			main {
				width: 100%;
				max-width: 720px;
				margin: 0 auto;
				padding: 48px 24px 80px;
			}

			/* Reading Progress Bar */
			.reading-progress-bar {
				position: fixed;
				top: 0;
				left: 0;
				width: 0%;
				height: 2px;
				background: var(--accent-primary);
				z-index: 9999;
				transition: width 0.1s ease-out;
			}

			/* Post Header */
			.post-header {
				margin-bottom: 40px;
			}

			.post-meta {
				display: flex;
				align-items: center;
				gap: 12px;
				margin-bottom: 16px;
				font-size: 0.8125rem;
				color: var(--text-muted);
			}

			.post-meta-divider {
				color: var(--border-color);
			}

			.post-title {
				font-size: 2.5rem;
				font-weight: 800;
				color: var(--text-primary);
				margin: 0 0 16px 0;
				line-height: 1.15;
				letter-spacing: -0.035em;
			}

			.post-description {
				font-size: 1rem;
				color: var(--text-secondary);
				margin: 0;
				line-height: 1.6;
			}

			/* Post Content */
			.post-content {
				color: var(--text-primary);
				font-size: 1rem;
				line-height: 1.75;
			}

			.post-content h2 {
				font-size: 1.625rem;
				font-weight: 700;
				margin: 2.5rem 0 1rem 0;
				padding-bottom: 8px;
				border-bottom: 1px solid var(--border-color);
				letter-spacing: -0.025em;
			}

			.post-content h3 {
				font-size: 1.25rem;
				font-weight: 700;
				margin: 2rem 0 0.75rem 0;
				letter-spacing: -0.02em;
			}

			.post-content h4 {
				font-size: 1.0625rem;
				font-weight: 700;
				margin: 1.5rem 0 0.5rem 0;
			}

			.post-content p {
				margin: 0 0 1.5rem 0;
			}

			.post-content ul, .post-content ol {
				margin: 0 0 1.5rem 0;
				padding-left: 1.5rem;
			}

			.post-content li {
				margin-bottom: 0.5rem;
			}

			.post-content a {
				color: var(--accent-primary);
				text-decoration: none;
			}

			.post-content a:hover {
				text-decoration: underline;
			}

			.post-content blockquote {
				border-left: 2px solid var(--border-color);
				padding: 0.5rem 0 0.5rem 1rem;
				margin: 1.5rem 0;
				color: var(--text-secondary);
			}

			.post-content blockquote p {
				margin: 0;
			}

			.post-content pre {
				background: var(--code-block-bg);
				border-radius: var(--radius-md);
				padding: 1.25rem;
				overflow-x: auto;
				margin: 1.5rem 0;
				border: 1px solid var(--border-color);
			}

			.post-content code {
				font-family: 'SF Mono', Menlo, Consolas, monospace;
				font-size: 0.875em;
			}

			.post-content :not(pre) > code {
				background: var(--code-bg);
				padding: 0.2em 0.4em;
				border-radius: var(--radius-sm);
				color: var(--code-text);
			}

			.post-content img {
				max-width: 100%;
				height: auto;
				border-radius: var(--radius-md);
				margin: 1.5rem 0;
			}

			.post-content hr {
				border: none;
				border-top: 1px solid var(--border-color);
				margin: 2.5rem 0;
			}

			/* Table of Contents */
			:global(.toc) {
				margin-bottom: 2.5rem;
				padding: 1.25rem;
				background: var(--bg-secondary);
				border-radius: var(--radius-md);
				border: 1px solid var(--border-color);
			}

			:global(.toc:empty) {
				display: none;
			}

			:global(.toc-title) {
				font-size: 0.8125rem;
				font-weight: 500;
				color: var(--text-muted);
				margin: 0 0 0.75rem 0;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			:global(.toc-list) {
				list-style: none;
				padding: 0;
				margin: 0;
			}

			:global(.toc-list li) {
				margin: 0.35rem 0;
			}

			:global(.toc-list a) {
				color: var(--text-secondary) !important;
				text-decoration: none;
				font-size: 0.875rem;
				line-height: 1.5;
			}

			:global(.toc-list a:hover) {
				color: var(--accent-primary) !important;
			}

			:global(.toc-h3 a) {
				padding-left: 1rem;
				font-size: 0.8125rem;
			}

			/* Post Footer */
			.post-footer {
				margin-top: 48px;
				padding-top: 24px;
				border-top: 1px solid var(--border-color);
			}

			.post-footer-tags {
				display: flex;
				flex-wrap: wrap;
				align-items: center;
				gap: 8px;
			}

			.post-footer-tags span {
				color: var(--text-muted);
				font-size: 0.8125rem;
			}

			.footer-tag {
				font-size: 0.8125rem;
				color: var(--text-secondary);
				text-decoration: none;
			}

			.footer-tag:hover {
				color: var(--accent-primary);
				text-decoration: none;
			}

			.footer-tag:not(:last-child)::after {
				content: ',';
				margin-right: 4px;
			}

			/* Post Navigation */
			.post-navigation {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 16px;
				margin-top: 32px;
			}

			.nav-link {
				display: flex;
				flex-direction: column;
				padding: 16px;
				border: 1px solid var(--border-color);
				border-radius: var(--radius-md);
				text-decoration: none;
				transition: border-color var(--transition-fast);
			}

			.nav-link:hover {
				border-color: var(--border-hover);
				text-decoration: none;
			}

			.nav-link.prev {
				text-align: left;
			}

			.nav-link.next {
				text-align: right;
			}

			.nav-label {
				font-size: 0.75rem;
				color: var(--text-muted);
				margin-bottom: 4px;
			}

			.nav-title {
				font-size: 0.875rem;
				color: var(--text-primary);
				font-weight: 500;
				line-height: 1.4;
			}

			.nav-link:hover .nav-title {
				color: var(--accent-primary);
			}

			.nav-placeholder {
				display: none;
			}

			/* Related Posts */
			.related-posts {
				margin-top: 32px;
				padding-top: 24px;
				border-top: 1px solid var(--border-color);
			}

			.related-title {
				font-size: 0.8125rem;
				font-weight: 500;
				color: var(--text-muted);
				margin: 0 0 12px 0;
				text-transform: uppercase;
				letter-spacing: 0.05em;
			}

			.related-list {
				list-style: none;
				padding: 0;
				margin: 0;
			}

			.related-list li {
				margin: 0;
			}

			.related-list a {
				display: flex;
				justify-content: space-between;
				align-items: center;
				padding: 10px 0;
				text-decoration: none;
				border-bottom: 1px solid var(--border-color);
			}

			.related-list li:last-child a {
				border-bottom: none;
			}

			.related-list a:hover .related-post-title {
				color: var(--accent-primary);
			}

			.related-post-title {
				color: var(--text-primary);
				font-size: 0.875rem;
				flex: 1;
				margin-right: 16px;
			}

			.related-list time {
				color: var(--text-muted);
				font-size: 0.8125rem;
				flex-shrink: 0;
			}

			/* Code Block Copy Button */
			:global(.code-block-wrapper) {
				position: relative;
			}

			:global(.copy-button) {
				position: absolute;
				top: 8px;
				right: 8px;
				display: flex;
				align-items: center;
				justify-content: center;
				width: 28px;
				height: 28px;
				background: var(--bg-tertiary);
				border: 1px solid var(--border-color);
				border-radius: var(--radius-sm);
				color: var(--text-muted);
				cursor: pointer;
				opacity: 0;
				transition: opacity var(--transition-fast);
			}

			:global(.code-block-wrapper:hover .copy-button) {
				opacity: 1;
			}

			:global(.copy-button:hover) {
				color: var(--text-primary);
				border-color: var(--border-hover);
			}

			:global(.copy-button.copied) {
				color: var(--accent-primary);
			}

			@media (max-width: 768px) {
				main {
					padding: 32px 20px 60px;
				}

				.post-title {
					font-size: 1.875rem;
				}

				.post-content {
					font-size: 0.9375rem;
				}

				.post-content h2 {
					font-size: 1.375rem;
				}

				.post-content h3 {
					font-size: 1.125rem;
				}

				.post-navigation {
					grid-template-columns: 1fr;
				}

				.nav-link.prev,
				.nav-link.next {
					text-align: left;
				}

				:global(.copy-button) {
					opacity: 1;
				}
			}
		</style>
	</head>

	<body>
		<div class="reading-progress-bar"></div>
		<Header slug={slug} />
		<main>
			<article>
				<header class="post-header">
					<div class="post-meta">
						<FormattedDate date={pubDate} />
						{updatedDate && (
							<>
								<span class="post-meta-divider">·</span>
								<span>수정됨</span>
							</>
						)}
						<span class="post-meta-divider">·</span>
						<span>{readingTime}분</span>
					</div>
					<h1 class="post-title">{title}</h1>
					{description && (
						<p class="post-description">{description}</p>
					)}
				</header>

				<div class="post-content">
					<nav class="toc" aria-label="목차"></nav>
					<slot />
				</div>

				{tags && tags.length > 0 && (
					<footer class="post-footer">
						<div class="post-footer-tags">
							<span>태그:</span>
							{tags.map((tag: string) => (
								<a href={`/tags/${tag}/`} class="footer-tag">{tag}</a>
							))}
						</div>
					</footer>
				)}

				{(prevPost || nextPost) && (
					<nav class="post-navigation">
						{prevPost ? (
							<a href={`/blog/${prevPost.slug}/`} class="nav-link prev">
								<span class="nav-label">← 이전</span>
								<span class="nav-title">{prevPost.title}</span>
							</a>
						) : <div class="nav-placeholder"></div>}
						{nextPost ? (
							<a href={`/blog/${nextPost.slug}/`} class="nav-link next">
								<span class="nav-label">다음 →</span>
								<span class="nav-title">{nextPost.title}</span>
							</a>
						) : <div class="nav-placeholder"></div>}
					</nav>
				)}

				{relatedPosts && relatedPosts.length > 0 && (
					<aside class="related-posts">
						<h3 class="related-title">관련 글</h3>
						<ul class="related-list">
							{relatedPosts.map((post) => (
								<li>
									<a href={`/blog/${post.slug}/`}>
										<span class="related-post-title">{post.title}</span>
										<time datetime={post.pubDate.toISOString()}>
											{`${post.pubDate.getFullYear()}.${String(post.pubDate.getMonth() + 1).padStart(2, '0')}.${String(post.pubDate.getDate()).padStart(2, '0')}`}
										</time>
									</a>
								</li>
							))}
						</ul>
					</aside>
				)}
			</article>
		</main>
		<Footer />

		<script>
			// Reading progress bar with throttling (requestAnimationFrame)
			const progressBar = document.querySelector('.reading-progress-bar') as HTMLElement;
			if (progressBar) {
				let ticking = false;
				window.addEventListener('scroll', () => {
					if (!ticking) {
						window.requestAnimationFrame(() => {
							const scrollTop = window.scrollY;
							const docHeight = document.documentElement.scrollHeight - window.innerHeight;
							const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
							progressBar.style.width = `${Math.min(progress, 100)}%`;
							ticking = false;
						});
						ticking = true;
					}
				});
			}

			// Native lazy loading for images
			document.querySelectorAll('.post-content img').forEach(img => {
				if (!img.hasAttribute('loading')) img.setAttribute('loading', 'lazy');
				if (!img.hasAttribute('decoding')) img.setAttribute('decoding', 'async');
			});

			(function() {
				const content = document.querySelector('.post-content');
				const toc = document.querySelector('.toc');
				if (!content || !toc) return;

				const headings = content.querySelectorAll('h2, h3');
				if (headings.length < 3) return;

				headings.forEach((heading, index) => {
					if (!heading.id) {
						heading.id = `heading-${index}`;
					}
				});

				const tocTitle = document.createElement('p');
				tocTitle.className = 'toc-title';
				tocTitle.textContent = 'Contents';

				const tocList = document.createElement('ul');
				tocList.className = 'toc-list';

				headings.forEach(heading => {
					const li = document.createElement('li');
					li.className = heading.tagName === 'H3' ? 'toc-h3' : '';
					const a = document.createElement('a');
					a.href = `#${heading.id}`;
					a.textContent = heading.textContent;
					li.appendChild(a);
					tocList.appendChild(li);
				});

				toc.appendChild(tocTitle);
				toc.appendChild(tocList);
			})();

			const clipboardIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;
			const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

			document.querySelectorAll('.post-content pre').forEach(pre => {
				const wrapper = document.createElement('div');
				wrapper.className = 'code-block-wrapper';
				pre.parentNode?.insertBefore(wrapper, pre);
				wrapper.appendChild(pre);

				const button = document.createElement('button');
				button.className = 'copy-button';
				button.innerHTML = clipboardIcon;
				button.setAttribute('aria-label', '코드 복사');

				button.addEventListener('click', async () => {
					const code = pre.querySelector('code')?.textContent || pre.textContent || '';
					try {
						await navigator.clipboard.writeText(code);
						button.innerHTML = checkIcon;
						button.classList.add('copied');
						setTimeout(() => {
							button.innerHTML = clipboardIcon;
							button.classList.remove('copied');
						}, 2000);
					} catch (err) {
						setTimeout(() => {
							button.innerHTML = clipboardIcon;
						}, 2000);
					}
				});

				wrapper.appendChild(button);
			});
		</script>
	</body>
</html>
